{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "payment-hooks",
  "title": "PowerTranz payment hooks",
  "description": "React hooks and API route handlers for PowerTranz payment flows including tokenization, authorization, capture, refund, void, and hosted payment pages.",
  "type": "registry:block",
  "author": "PowerTranz <support@powertranz.com>",
  "categories": [
    "payments",
    "integrations",
    "react-hooks",
    "api-routes"
  ],
  "docs": "This registry item provides a complete payment integration with PowerTranz.",
  "envVars": {
    "POWERTRANZ_BASE_URL": "PowerTranz API base URL (e.g., https://ptranz.com/api)",
    "POWERTRANZ_MERCHANT_ID": "Your PowerTranz merchant ID",
    "POWERTRANZ_PROCESSING_PASSWORD": "Your PowerTranz processing password",
    "POWERTRANZ_DEFAULT_CURRENCY": "Optional: Default currency code (default: 780 for TTD)"
  },
  "registryDependencies": [],
  "dependencies": [
    "axios"
  ],
  "files": [
    {
      "path": "registry/payment-hooks/lib/powertranz/types.ts",
      "type": "registry:lib",
      "content": "/**\n * Generic result type for all hook operations.\n * Use pattern matching to handle success and error cases.\n *\n * @example\n * const result = await tokenizeCard(props);\n * if (result.ok) {\n *   console.log('Token:', result.data.PanToken);\n * } else {\n *   console.error('Error:', result.error.message);\n * }\n */\nexport type Result<T> =\n  | { ok: true; data: T }\n  | { ok: false; error: { message: string; isoCode?: string; raw?: unknown } };\n\nexport interface TokenizeCardProps {\n  cardNumber: string;\n  expirationYear: string;\n  expirationMonth: string;\n  cvv: string;\n  cardholderName: string;\n  currencyCode?: string;\n}\n\nexport interface TokenizeCardResponse {\n  TransactionType: number;\n  TotalAmount: number;\n  Approved: boolean;\n  TransactionIdentifier: string;\n  IsoResponseCode: string;\n  PanToken?: string;\n  ResponseMessage: string;\n  OrderIdentifier: string;\n  Errors?: Array<{ Code: string; Message: string }>;\n  CardBrand?: string;\n  CurrencyCode?: string;\n}\n\nexport interface CapturePaymentProps {\n  transactionIdentifier: string;\n  amount: number;\n}\n\nexport interface CapturePaymentResponse {\n  OriginalTrxnIdentifier: string;\n  TransactionType: number;\n  Approved: boolean;\n  TransactionIdentifier: string;\n  TotalAmount: number;\n  CurrencyCode: string;\n  RRN: string;\n  IsoResponseCode: string;\n  ResponseMessage: string;\n  OrderIdentifier: string;\n}\n\nexport interface AuthFlowProps {\n  orderId: string;\n  amount: number;\n  siteRoot: string;\n  transactionIdentifier: string;\n  token: string;\n  email: string;\n  authOnly?: boolean;\n}\n\nexport interface DirectSaleProps {\n  orderId: string;\n  amount: number;\n  transactionIdentifier: string;\n  cardNumber: string;\n  cardCvv: string;\n  cardExpiration: string;\n  cardholderName: string;\n  currencyCode?: string;\n}\n\nexport interface RefundProps {\n  transactionIdentifier: string;\n  amount: number;\n  currencyCode?: string;\n}\n\nexport interface HostedPageProps {\n  orderId: string;\n  amount: number;\n  transactionIdentifier: string;\n  pageSet: string;\n  pageName: string;\n  siteRoot: string;\n  threeDSecure?: boolean;\n}\n\nexport interface RecurringSetupProps {\n  orderId: string;\n  amount: number;\n  transactionIdentifier: string;\n  cardToken?: string;\n  cardPan?: string;\n  cardCvv?: string;\n  cardExpiration?: string;\n  cardholderName?: string;\n  email?: string;\n  currencyCode?: string;\n  startDate: string;\n  expiryDate: string;\n  frequency: \"D\" | \"W\" | \"F\" | \"M\" | \"B\" | \"Q\" | \"S\" | \"Y\";\n  threeDSecure?: boolean;\n}\n\nexport interface RecurringCancelProps {\n  recurringIdentifier: string;\n}\n\nexport interface VoidProps {\n  transactionIdentifier: string;\n}\n"
    },
    {
      "path": "registry/payment-hooks/lib/powertranz/client.ts",
      "type": "registry:lib",
      "content": "import axios from \"axios\";\nimport { sanitizeForLogging } from \"./utils\";\n\nconst getEnv = (key: string): string => {\n  const value = process.env[key];\n  if (!value) {\n    throw new Error(`Missing required environment variable: ${key}`);\n  }\n  return value;\n};\n\nexport const powertranzConfig = {\n  baseUrl: getEnv(\"POWERTRANZ_BASE_URL\"),\n  merchantId: getEnv(\"POWERTRANZ_MERCHANT_ID\"),\n  password: getEnv(\"POWERTRANZ_PROCESSING_PASSWORD\"),\n  defaultCurrency: process.env.POWERTRANZ_DEFAULT_CURRENCY || \"780\",\n};\n\nexport const createPowertranzClient = () => {\n  return axios.create({\n    baseURL: powertranzConfig.baseUrl,\n    headers: {\n      \"PowerTranz-PowerTranzId\": powertranzConfig.merchantId,\n      \"PowerTranz-PowerTranzPassword\": powertranzConfig.password,\n      \"Content-Type\": \"application/json; charset=utf-8\",\n    },\n    timeout: 30000,\n  });\n};\n\nexport { sanitizeForLogging };\n"
    },
    {
      "path": "registry/payment-hooks/lib/powertranz/utils.ts",
      "type": "registry:lib",
      "content": "export function maskCardNumber(cardNumber: string): string {\n  if (cardNumber.length <= 4) return \"****\";\n  return \"****\" + cardNumber.slice(-4);\n}\n\nfunction sanitizeValue(value: unknown): unknown {\n  if (typeof value === \"string\") {\n    return value;\n  }\n  if (typeof value === \"object\" && value !== null && !Array.isArray(value)) {\n    return sanitizeForLogging(value as Record<string, unknown>);\n  }\n  return value;\n}\n\nexport function sanitizeForLogging(obj: Record<string, unknown>): Record<string, unknown> {\n  const sensitiveFields = [\"CardPan\", \"CardCvv\", \"cardNumber\", \"cvv\", \"panToken\", \"token\", \"cardExpiration\"];\n  const sanitized: Record<string, unknown> = {};\n  \n  for (const [key, value] of Object.entries(obj)) {\n    if (sensitiveFields.includes(key) && typeof value === \"string\") {\n      if (key === \"CardPan\" || key === \"cardNumber\") {\n        sanitized[key] = maskCardNumber(value);\n      } else if (key === \"token\") {\n        sanitized[key] = \"********\";\n      } else if (key === \"cardExpiration\") {\n        sanitized[key] = \"****\";\n      } else {\n        sanitized[key] = \"***\";\n      }\n    } else {\n      sanitized[key] = sanitizeValue(value);\n    }\n  }\n  \n  return sanitized;\n}\n"
    },
    {
      "path": "registry/payment-hooks/lib/powertranz/index.ts",
      "type": "registry:lib",
      "content": "export * from \"./types\";\nexport * from \"./client\";\nexport * from \"./utils\";\n"
    },
    {
      "path": "registry/payment-hooks/components/hooks/use-powertranz.ts",
      "type": "registry:hook",
      "content": "import { useState } from \"react\";\nimport type {\n  Result,\n  TokenizeCardProps,\n  TokenizeCardResponse,\n  CapturePaymentProps,\n  CapturePaymentResponse,\n  AuthFlowProps,\n  DirectSaleProps,\n  RefundProps,\n  HostedPageProps,\n  RecurringSetupProps,\n  RecurringCancelProps,\n  VoidProps,\n} from \"@/lib/powertranz\";\n\nasync function handleApiCall<T>(\n  url: string,\n  data: unknown,\n  setLoading: (loading: boolean) => void\n): Promise<Result<T>> {\n  try {\n    setLoading(true);\n    const response = await fetch(url, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(data),\n    });\n\n    const result = await response.json();\n\n    if (!response.ok) {\n      return {\n        ok: false,\n        error: {\n          message: result.message || \"API request failed\",\n          isoCode: result.IsoResponseCode,\n          raw: result,\n        },\n      };\n    }\n\n    return { ok: true, data: result };\n  } catch (error) {\n    return {\n      ok: false,\n      error: {\n        message: error instanceof Error ? error.message : \"Unknown error\",\n        raw: error,\n      },\n    };\n  } finally {\n    setLoading(false);\n  }\n}\n\n/**\n * PowerTranz payment hook for React components.\n * Provides methods for all payment operations with built-in loading and error handling.\n *\n * @example\n * const { tokenizeCard, capture, loading, error } = usePowertranz();\n *\n * const handleSubmit = async () => {\n *   const result = await tokenizeCard({ cardNumber: \"...\", ... });\n *   if (result.ok) {\n *     // Success - use result.data.PanToken\n *   }\n * };\n *\n * @returns Object containing payment methods and loading state\n */\nconst usePowertranz = () => {\n  const [loading, setLoading] = useState(false);\n\n  /**\n   * Start a 3D Secure authentication flow.\n   * Use after tokenizing a card to authenticate the transaction.\n   *\n   * @param props - Authentication flow parameters\n   * @returns Result containing redirectData (HTML blob) and spiToken\n   */\n  const startAuth = async (props: AuthFlowProps): Promise<Result<{ redirectData: string; spiToken: string }>> => {\n    if (!props.siteRoot) {\n      return { ok: false, error: { message: \"Running in SSR mode\" } };\n    }\n\n    const result = await handleApiCall<{ RedirectData: string; SpiToken: string }>(\n      \"/api/powertranz/auth\",\n      props,\n      setLoading\n    );\n\n    if (result.ok && result.data) {\n      return { ok: true, data: { redirectData: result.data.RedirectData, spiToken: result.data.SpiToken } };\n    }\n\n    if (!result.ok && result.error) {\n      return { ok: false, error: result.error };\n    }\n\n    return { ok: false, error: { message: \"Unknown error\" } };\n  };\n\n  /**\n   * Capture a previously authorized transaction.\n   * Call this after successful 3D Secure authentication.\n   *\n   * @param props - Capture parameters (transactionIdentifier, amount)\n   * @returns Capture response with approval details\n   */\n  const capture = async (props: CapturePaymentProps): Promise<Result<CapturePaymentResponse>> => {\n    return handleApiCall<CapturePaymentResponse>(\"/api/powertranz/capture\", props, setLoading);\n  };\n\n  /**\n   * Tokenize a card for secure storage.\n   * Returns a PanToken that can be safely stored and used for future transactions.\n   *\n   * @param props - Card details to tokenize\n   * @returns Tokenization response with PanToken\n   */\n  const tokenizeCard = async (props: TokenizeCardProps): Promise<Result<TokenizeCardResponse>> => {\n    return handleApiCall<TokenizeCardResponse>(\"/api/powertranz/tokenize\", props, setLoading);\n  };\n\n  /**\n   * Perform a direct sale (authorization + capture in one step).\n   * Use when you don't need to store the card for later use.\n   *\n   * @param props - Sale parameters including raw card details\n   * @returns Sale response with approval details\n   */\n  const directSale = async (props: DirectSaleProps): Promise<Result<unknown>> => {\n    return handleApiCall(\"/api/powertranz/sale\", props, setLoading);\n  };\n\n  /**\n   * Refund a previous transaction.\n   * Can refund partial or full amount.\n   *\n   * @param props - Refund parameters\n   * @returns Refund response\n   */\n  const refund = async (props: RefundProps): Promise<Result<unknown>> => {\n    return handleApiCall(\"/api/powertranz/refund\", props, setLoading);\n  };\n\n  /**\n   * Start a Hosted Payment Page (HPP) session.\n   * Returns an iframe-compatible HTML blob for secure payment collection.\n   * Use PowertranzIframe component to display.\n   *\n   * @param props - HPP session parameters\n   * @returns Result with redirectData (HTML blob) and spiToken\n   */\n  const startHostedPageSession = async (props: HostedPageProps): Promise<Result<{ redirectData: string; spiToken: string }>> => {\n    const result = await handleApiCall<{ RedirectData: string; SpiToken: string }>(\n      \"/api/powertranz/hpp/start\",\n      props,\n      setLoading\n    );\n\n    if (result.ok && result.data) {\n      return { ok: true, data: { redirectData: result.data.RedirectData, spiToken: result.data.SpiToken } };\n    }\n\n    if (!result.ok && result.error) {\n      return { ok: false, error: result.error };\n    }\n\n    return { ok: false, error: { message: \"Unknown error\" } };\n  };\n\n  /**\n   * Set up a managed recurring payment schedule.\n   * Charges the card on a recurring basis according to the configured schedule.\n   *\n   * @param props - Recurring setup parameters\n   * @returns Response with RecurringIdentifier\n   */\n  const setupManagedRecurring = async (props: RecurringSetupProps): Promise<Result<unknown>> => {\n    return handleApiCall(\"/api/powertranz/recurring/setup\", props, setLoading);\n  };\n\n  /**\n   * Cancel an existing recurring payment schedule.\n   *\n   * @param props - Cancel parameters with RecurringIdentifier\n   * @returns Cancellation response\n   */\n  const cancelManagedRecurring = async (props: RecurringCancelProps): Promise<Result<unknown>> => {\n    return handleApiCall(\"/api/powertranz/recurring/cancel\", props, setLoading);\n  };\n\n  /**\n   * Void an authorization before capture.\n   * Use to cancel an authorization without charging the card.\n   *\n   * @param props - Void parameters with transactionIdentifier\n   * @returns Void response\n   */\n  const voidAuthorization = async (props: VoidProps): Promise<Result<unknown>> => {\n    return handleApiCall(\"/api/powertranz/void\", props, setLoading);\n  };\n\n  return {\n    startAuth,\n    capture,\n    tokenizeCard,\n    directSale,\n    refund,\n    startHostedPageSession,\n    setupManagedRecurring,\n    cancelManagedRecurring,\n    voidAuthorization,\n    loading,\n  };\n};\n\nexport default usePowertranz;\n\nexport type {\n  TokenizeCardProps,\n  TokenizeCardResponse,\n  CapturePaymentProps,\n  CapturePaymentResponse,\n  AuthFlowProps,\n  DirectSaleProps,\n  RefundProps,\n  HostedPageProps,\n  RecurringSetupProps,\n  RecurringCancelProps,\n  VoidProps,\n};\n"
    },
    {
      "path": "registry/payment-hooks/components/powertranz-iframe.tsx",
      "type": "registry:component",
      "content": "\"use client\";\n\nimport { useEffect, useState } from \"react\";\n\nexport interface PowertranzMessagePayload {\n  type: \"powertranz-complete\" | \"powertranz-error\";\n  payload?: unknown;\n  message?: string;\n}\n\nexport interface PowertranzIframeProps {\n  redirectData: string;\n  onComplete?: (data: PowertranzMessagePayload[\"payload\"]) => void;\n  onError?: (error: Error) => void;\n  className?: string;\n  height?: string;\n  width?: string;\n}\n\nexport function PowertranzIframe({\n  redirectData,\n  onComplete,\n  onError,\n  className = \"\",\n  height = \"500px\",\n  width = \"100%\",\n}: PowertranzIframeProps) {\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const handleMessage = (event: MessageEvent) => {\n      try {\n        const data = typeof event.data === \"string\" ? JSON.parse(event.data) : event.data;\n\n        if (\n          typeof data !== \"object\" ||\n          data === null ||\n          typeof data.type !== \"string\"\n        ) {\n          return;\n        }\n\n        if (data.type === \"powertranz-complete\") {\n          onComplete?.(data.payload);\n        } else if (data.type === \"powertranz-error\") {\n          const err = new Error(data.message || \"Payment flow error\");\n          setError(data.message);\n          onError?.(err);\n        }\n      } catch (e) {\n        console.error(\"Failed to parse PowerTranz message:\", e);\n      }\n    };\n\n    window.addEventListener(\"message\", handleMessage);\n    return () => window.removeEventListener(\"message\", handleMessage);\n  }, [onComplete, onError]);\n\n  if (error) {\n    return (\n      <div className={`p-4 border border-red-200 rounded bg-red-50 text-red-700 ${className}`}>\n        <p className=\"font-medium\">Payment Error</p>\n        <p className=\"text-sm\">{error}</p>\n      </div>\n    );\n  }\n\n  return (\n    <iframe\n      srcDoc={redirectData}\n      title=\"PowerTranz Payment\"\n      height={height}\n      width={width}\n      className={`border-0 rounded-lg ${className}`}\n      style={{ borderStyle: \"solid\", borderWidth: \"0px\", paddingLeft: \"5%\" }}\n    />\n  );\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/tokenize/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/tokenize/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { TokenizeCardProps, createPowertranzClient, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport const dynamic = \"force-dynamic\";\n\nexport async function POST(request: Request) {\n  const data = (await request.json()) as TokenizeCardProps;\n  const {\n    cardNumber,\n    cvv,\n    expirationYear,\n    expirationMonth,\n    cardholderName,\n    currencyCode,\n  } = data;\n\n  console.log(\"Tokenize request (sanitized):\", sanitizeForLogging({ cardNumber, cvv, expirationYear, expirationMonth, cardholderName, currencyCode }));\n\n  const transactionIdentifier = crypto.randomUUID();\n  const orderId = crypto.randomUUID();\n\n  const client = createPowertranzClient();\n\n  try {\n    const response = await client.post(\"/riskmgmt\", {\n      AddressMatch: false,\n      CurrencyCode: currencyCode || \"780\",\n      TransactionIdentifier: transactionIdentifier,\n      TotalAmount: 0,\n      Tokenize: true,\n      ThreeDSecure: false,\n      OrderIdentifier: orderId,\n      Source: {\n        CardPan: cardNumber,\n        CardCvv: cvv,\n        CardExpiration: `${expirationYear}${expirationMonth}`,\n        CardholderName: cardholderName,\n      },\n    });\n\n    console.log(\"Tokenize response:\", sanitizeForLogging(response.data));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz tokenize error:\", error);\n    return NextResponse.json(\n      { error: \"Tokenization failed\", message: \"Failed to tokenize card\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/auth/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/auth/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { AuthFlowProps, createPowertranzClient, powertranzConfig, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: Request) {\n  const data = (await request.json()) as AuthFlowProps;\n  const {\n    siteRoot,\n    token,\n    amount,\n    orderId,\n    transactionIdentifier,\n    email,\n    authOnly,\n  } = data;\n\n  console.log(\"Auth request (sanitized):\", sanitizeForLogging({ amount, token, orderId, transactionIdentifier, email, authOnly }));\n\n  const client = createPowertranzClient();\n\n  try {\n    const response = await client.post(\"/spi/auth\", {\n      TransactionIdentifier: transactionIdentifier,\n      TotalAmount: Number(amount),\n      CurrencyCode: powertranzConfig.defaultCurrency,\n      ThreeDSecure: true,\n      FraudCheck: true,\n      OrderIdentifier: orderId,\n      Source: {\n        Token: token,\n      },\n      BillingAddress: {\n        EmailAddress: email,\n      },\n      ExtendedData: {\n        ThreeDSecure: {\n          ChallengeWindowSize: 4,\n          ChallengeIndicator: \"01\",\n        },\n        MerchantResponseUrl: `${siteRoot}/api/powertranz/${authOnly ? \"auth-response\" : \"response\"}`,\n      },\n    });\n\n    console.log(\"Auth response:\", sanitizeForLogging(response.data));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz auth error:\", error);\n    return NextResponse.json(\n      { error: \"Authorization failed\", message: \"Failed to initiate authorization\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/auth-response/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/auth-response/route.ts",
      "content": "import { NextRequest, NextResponse } from \"next/server\";\nimport { createPowertranzClient, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: NextRequest) {\n  try {\n    const headers = {\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\n    };\n\n    const formData = await request.formData();\n    const responseData = formData.get(\"Response\") as string;\n\n    console.log(\"Auth response callback (raw):\", responseData);\n\n    const authResponse = JSON.parse(responseData);\n    console.log(\"Auth response callback (sanitized):\", sanitizeForLogging(authResponse));\n\n    let error = null;\n\n    if (authResponse.IsoResponseCode === \"3D0\" || authResponse.IsoResponseCode === \"3D1\") {\n      const client = createPowertranzClient();\n\n      const paymentResult = await client.post(\"/spi/payment\", JSON.stringify(authResponse.SpiToken), {\n        headers: { \"Content-Type\": \"text/plain\" },\n      });\n      const paymentResponse = paymentResult.data;\n      console.log(\"Payment response (sanitized):\", sanitizeForLogging(paymentResponse));\n\n      if (paymentResponse.IsoResponseCode === \"00\") {\n        const urlParams = new URLSearchParams({\n          isSuccess: \"1\",\n          order_id: authResponse.OrderIdentifier,\n          txn_type: \"auth-only\",\n          responseCode: paymentResponse.IsoResponseCode,\n          responseMessage: paymentResponse.ResponseMessage || \"\",\n          referenceNumber: paymentResponse.RRN || \"\",\n          transactionIdentifier: paymentResponse.TransactionIdentifier || \"\",\n        });\n\n        const origin = new URL(request.url).origin;\n        return NextResponse.redirect(`${origin}/response?${urlParams.toString()}`, { status: 302, headers });\n      } else {\n        error = {\n          txnType: \"payment\",\n          code: paymentResponse.IsoResponseCode,\n          message: paymentResponse.ResponseMessage,\n          additionalErrors: paymentResponse.Errors || null,\n        };\n      }\n    } else {\n      error = {\n        txnType: \"auth\",\n        code: authResponse.IsoResponseCode,\n        message: authResponse.ResponseMessage,\n        additionalErrors: authResponse.Errors || null,\n      };\n    }\n\n    const errorParams = new URLSearchParams({\n      isSuccess: \"0\",\n      order_id: authResponse.OrderIdentifier || \"\",\n      txn_type: error?.txnType || \"\",\n      responseCode: error?.code || \"\",\n      responseMessage: error?.message || \"\",\n      type: \"Online Credit/Debit Card\",\n    });\n\n    if (error?.additionalErrors) {\n      errorParams.append(\"errors\", JSON.stringify(error.additionalErrors));\n    }\n\n    const origin = new URL(request.url).origin;\n    return NextResponse.redirect(`${origin}/response?${errorParams.toString()}`, { status: 302, headers });\n  } catch (error) {\n    console.error(\"Auth response callback error:\", error);\n    const errorParams = new URLSearchParams({\n      isSuccess: \"2\",\n      errors: error instanceof Error ? error.message : \"Unknown error occurred\",\n      type: \"Online Credit/Debit Card\",\n    });\n\n    const origin = new URL(request.url).origin;\n    return NextResponse.redirect(`${origin}/response?${errorParams.toString()}`, {\n      status: 302,\n      headers: { \"Access-Control-Allow-Origin\": \"*\" },\n    });\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/capture/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/capture/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { CapturePaymentProps, createPowertranzClient, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: Request) {\n  const data = (await request.json()) as CapturePaymentProps;\n\n  console.log(\"Capture request (sanitized):\", sanitizeForLogging({\n    transactionIdentifier: data.transactionIdentifier,\n    amount: data.amount,\n  }));\n\n  const client = createPowertranzClient();\n\n  try {\n    const response = await client.post(\"/capture\", {\n      TransactionIdentifier: data.transactionIdentifier,\n      TotalAmount: Number(data.amount),\n    });\n\n    console.log(\"Capture response (sanitized):\", sanitizeForLogging(response.data));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz capture error:\", error);\n    return NextResponse.json(\n      { error: \"Capture failed\", message: \"Failed to capture authorization\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/sale/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/sale/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { DirectSaleProps, createPowertranzClient, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: Request) {\n  const data = (await request.json()) as DirectSaleProps;\n\n  console.log(\"Direct sale request (sanitized):\", sanitizeForLogging({\n    amount: data.amount,\n    orderId: data.orderId,\n    transactionIdentifier: data.transactionIdentifier,\n  }));\n\n  const client = createPowertranzClient();\n\n  try {\n    const response = await client.post(\"/sale\", {\n      TransactionIdentifier: data.transactionIdentifier,\n      TotalAmount: Number(data.amount),\n      CurrencyCode: data.currencyCode || \"780\",\n      ThreeDSecure: false,\n      OrderIdentifier: data.orderId,\n      Source: {\n        CardPan: data.cardNumber,\n        CardCvv: data.cardCvv,\n        CardExpiration: data.cardExpiration,\n        CardholderName: data.cardholderName,\n      },\n    });\n\n    console.log(\"Direct sale response (sanitized):\", sanitizeForLogging(response.data));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz sale error:\", error);\n    return NextResponse.json(\n      { error: \"Sale failed\", message: \"Failed to process direct sale\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/refund/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/refund/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { createPowertranzClient, powertranzConfig, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: Request) {\n  const data = await request.json();\n  const { transactionIdentifier, amount } = data;\n\n  console.log(\"Refund request (sanitized):\", sanitizeForLogging({ transactionIdentifier, amount }));\n\n  const client = createPowertranzClient();\n\n  try {\n    const response = await client.post(\"/refund\", {\n      Refund: true,\n      TransactionIdentifier: transactionIdentifier,\n      TotalAmount: Number(amount),\n      CurrencyCode: powertranzConfig.defaultCurrency,\n    });\n\n    console.log(\"Refund response:\", sanitizeForLogging(response.data));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz refund error:\", error);\n    return NextResponse.json(\n      { error: \"Refund failed\", message: \"Failed to process refund\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/response/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/response/route.ts",
      "content": "import { NextRequest, NextResponse } from \"next/server\";\nimport { createPowertranzClient, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: NextRequest) {\n  try {\n    const headers = {\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\n    };\n\n    const formData = await request.formData();\n    const responseData = formData.get(\"Response\") as string;\n\n    console.log(\"Payment response callback (raw):\", responseData);\n\n    const authResponse = JSON.parse(responseData);\n    console.log(\"Payment response callback (sanitized):\", sanitizeForLogging(authResponse));\n\n    let error = null;\n\n    if (authResponse.IsoResponseCode === \"3D0\" || authResponse.IsoResponseCode === \"3D1\") {\n      const client = createPowertranzClient();\n\n      const paymentResult = await client.post(\"/spi/payment\", JSON.stringify(authResponse.SpiToken), {\n        headers: { \"Content-Type\": \"text/plain\" },\n      });\n      const paymentResponse = paymentResult.data;\n      console.log(\"Payment response (sanitized):\", sanitizeForLogging(paymentResponse));\n\n      if (paymentResponse.IsoResponseCode === \"00\") {\n        const captureResult = await client.post(\"/capture\", {\n          TransactionIdentifier: paymentResponse.TransactionIdentifier,\n          TotalAmount: paymentResponse.TotalAmount,\n        });\n        const captureResponse = captureResult.data;\n        console.log(\"Capture response (sanitized):\", sanitizeForLogging(captureResponse));\n\n        if (captureResponse.IsoResponseCode === \"00\") {\n          const urlParams = new URLSearchParams({\n            isSuccess: \"1\",\n            order_id: authResponse.OrderIdentifier,\n            txn_type: \"capture\",\n            responseCode: captureResponse.IsoResponseCode,\n            responseMessage: captureResponse.ResponseMessage || \"\",\n            referenceNumber: captureResponse.RRN || \"\",\n            transactionIdentifier: paymentResponse.TransactionIdentifier || \"\",\n          });\n\n          const origin = new URL(request.url).origin;\n          return NextResponse.redirect(`${origin}/response?${urlParams.toString()}`, { status: 302, headers });\n        } else {\n          error = {\n            txnType: \"capture\",\n            code: captureResponse.IsoResponseCode,\n            message: captureResponse.ResponseMessage,\n            additionalErrors: captureResponse.Errors || null,\n          };\n        }\n      } else {\n        error = {\n          txnType: \"payment\",\n          code: paymentResponse.IsoResponseCode,\n          message: paymentResponse.ResponseMessage,\n          additionalErrors: paymentResponse.Errors || null,\n        };\n      }\n    } else {\n      error = {\n        txnType: \"auth\",\n        code: authResponse.IsoResponseCode,\n        message: authResponse.ResponseMessage,\n        additionalErrors: authResponse.Errors || null,\n      };\n    }\n\n    const errorParams = new URLSearchParams({\n      isSuccess: \"0\",\n      order_id: authResponse.OrderIdentifier || \"\",\n      txn_type: error?.txnType || \"\",\n      responseCode: error?.code || \"\",\n      responseMessage: error?.message || \"\",\n      type: \"Online Credit/Debit Card\",\n    });\n\n    if (error?.additionalErrors) {\n      errorParams.append(\"errors\", JSON.stringify(error.additionalErrors));\n    }\n\n    const origin = new URL(request.url).origin;\n    return NextResponse.redirect(`${origin}/response?${errorParams.toString()}`, { status: 302, headers });\n  } catch (error) {\n    console.error(\"Payment response callback error:\", error);\n    const errorParams = new URLSearchParams({\n      isSuccess: \"2\",\n      errors: error instanceof Error ? error.message : \"Unknown error occurred\",\n      type: \"Online Credit/Debit Card\",\n    });\n\n    const origin = new URL(request.url).origin;\n    return NextResponse.redirect(`${origin}/response?${errorParams.toString()}`, {\n      status: 302,\n      headers: { \"Access-Control-Allow-Origin\": \"*\" },\n    });\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/hpp/start/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/hpp/start/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { HostedPageProps, createPowertranzClient, powertranzConfig, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: Request) {\n  const data = (await request.json()) as HostedPageProps;\n\n  console.log(\"HPP start request (sanitized):\", sanitizeForLogging({\n    amount: data.amount,\n    orderId: data.orderId,\n    transactionIdentifier: data.transactionIdentifier,\n    pageSet: data.pageSet,\n    pageName: data.pageName,\n  }));\n\n  const client = createPowertranzClient();\n\n  try {\n    const response = await client.post(\"/spi/auth\", {\n      TransactionIdentifier: data.transactionIdentifier,\n      TotalAmount: Number(data.amount),\n      CurrencyCode: powertranzConfig.defaultCurrency,\n      ThreeDSecure: data.threeDSecure ?? false,\n      OrderIdentifier: data.orderId,\n      AddressMatch: false,\n      ExtendedData: {\n        HostedPage: {\n          PageSet: data.pageSet,\n          PageName: data.pageName,\n        },\n        MerchantResponseUrl: `${data.siteRoot}/api/powertranz/hpp/response`,\n      },\n    });\n\n    console.log(\"HPP start response (sanitized):\", sanitizeForLogging(response.data));\n\n    if (response.data.IsoResponseCode !== \"SP4\") {\n      return NextResponse.json(\n        { error: \"HPP start failed\", message: response.data.ResponseMessage },\n        { status: 400 }\n      );\n    }\n\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz HPP start error:\", error);\n    return NextResponse.json(\n      { error: \"HPP start failed\", message: \"Failed to initiate hosted page session\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/recurring/setup/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/recurring/setup/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { RecurringSetupProps, createPowertranzClient, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: Request) {\n  const data = (await request.json()) as RecurringSetupProps;\n\n  console.log(\"Recurring setup request (sanitized):\", sanitizeForLogging({\n    amount: data.amount,\n    orderId: data.orderId,\n    transactionIdentifier: data.transactionIdentifier,\n    startDate: data.startDate,\n    expiryDate: data.expiryDate,\n    frequency: data.frequency,\n  }));\n\n  const client = createPowertranzClient();\n\n  const today = new Date();\n  const startDate = new Date(data.startDate);\n  const isToday = startDate.toDateString() === today.toDateString();\n\n  const extendedData: Record<string, unknown> = {\n    Recurring: {\n      Managed: true,\n      StartDate: data.startDate.replace(/-/g, \"\"),\n      ExpiryDate: data.expiryDate.replace(/-/g, \"\"),\n      Frequency: data.frequency,\n    },\n  };\n\n  if (isToday && data.threeDSecure) {\n    extendedData.ThreeDSecure = {\n      ChallengeWindowSize: 4,\n      ChallengeIndicator: \"01\",\n    };\n  }\n\n  const requestBody: Record<string, unknown> = {\n    TransactionIdentifier: data.transactionIdentifier,\n    TotalAmount: Number(data.amount),\n    CurrencyCode: data.currencyCode || \"780\",\n    ThreeDSecure: data.threeDSecure ?? true,\n    RecurringInitial: true,\n    OrderIdentifier: data.orderId,\n    ExtendedData: extendedData,\n  };\n\n  if (data.cardToken) {\n    requestBody.Source = { Token: data.cardToken };\n  } else if (data.cardPan) {\n    if (!data.cardCvv || !data.cardExpiration || !data.cardholderName) {\n      return NextResponse.json(\n        { error: \"Validation failed\", message: \"When providing cardPan, cardCvv, cardExpiration, and cardholderName are all required\" },\n        { status: 400 }\n      );\n    }\n    requestBody.Source = {\n      CardPan: data.cardPan,\n      CardCvv: data.cardCvv,\n      CardExpiration: data.cardExpiration,\n      CardholderName: data.cardholderName,\n    };\n  }\n\n  if (data.email) {\n    requestBody.BillingAddress = { EmailAddress: data.email };\n  }\n\n  const endpoint = isToday ? \"/spi/sale\" : \"/spi/auth\";\n\n  try {\n    const response = await client.post(endpoint, requestBody);\n\n    console.log(\"Recurring setup response (sanitized):\", sanitizeForLogging(response.data));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz recurring setup error:\", error);\n    return NextResponse.json(\n      { error: \"Recurring setup failed\", message: \"Failed to setup recurring transaction\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/recurring/cancel/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/recurring/cancel/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { RecurringCancelProps, createPowertranzClient, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: Request) {\n  const data = (await request.json()) as RecurringCancelProps;\n\n  console.log(\"Recurring cancel request (sanitized):\", sanitizeForLogging({\n    recurringIdentifier: data.recurringIdentifier,\n  }));\n\n  const client = createPowertranzClient();\n\n  try {\n    const response = await client.post(\"/admin/recurring/cancel\", {\n      RecurringIdentifier: data.recurringIdentifier,\n    });\n\n    console.log(\"Recurring cancel response (sanitized):\", sanitizeForLogging(response.data));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz recurring cancel error:\", error);\n    return NextResponse.json(\n      { error: \"Recurring cancel failed\", message: \"Failed to cancel recurring transaction\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/recurring/webhook/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/recurring/webhook/route.ts",
      "content": "import { NextRequest, NextResponse } from \"next/server\";\nimport { sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: NextRequest) {\n  try {\n    const data = await request.json();\n\n    console.log(\"Recurring webhook received (sanitized):\", sanitizeForLogging(data));\n\n    const responseCode = data.ResponseCode || data.IsoResponseCode;\n\n    const validResponseCodes = [\"R0\", \"R1\", \"R4\", \"R5\", \"RD0\", \"RD1\", \"RD2\", \"RD3\", \"RE\"];\n    if (responseCode && !validResponseCodes.includes(responseCode)) {\n      console.warn(\"Unknown recurring response code:\", responseCode);\n    }\n\n    return new NextResponse(null, { status: 200 });\n  } catch (error) {\n    console.error(\"Recurring webhook error:\", error);\n    return new NextResponse(null, { status: 200 });\n  }\n}\n\nexport async function OPTIONS() {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n      \"Access-Control-Allow-Headers\": \"Content-Type\",\n    },\n  });\n}\n"
    },
    {
      "path": "registry/payment-hooks/app/api/powertranz/void/route.ts",
      "type": "registry:page",
      "target": "app/api/powertranz/void/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { VoidProps, createPowertranzClient, powertranzConfig, sanitizeForLogging } from \"@/lib/powertranz\";\n\nexport async function POST(request: Request) {\n  const data = (await request.json()) as VoidProps;\n\n  console.log(\"Void request (sanitized):\", sanitizeForLogging({\n    transactionIdentifier: data.transactionIdentifier,\n  }));\n\n  const client = createPowertranzClient();\n\n  try {\n    const response = await client.post(\"/void\", {\n      Void: true,\n      TransactionIdentifier: data.transactionIdentifier,\n      CurrencyCode: powertranzConfig.defaultCurrency,\n    });\n\n    console.log(\"Void response (sanitized):\", sanitizeForLogging(response.data));\n    return NextResponse.json(response.data);\n  } catch (error) {\n    console.error(\"PowerTranz void error:\", error);\n    return NextResponse.json(\n      { error: \"Void failed\", message: \"Failed to void authorization\" },\n      { status: 500 }\n    );\n  }\n}\n"
    }
  ]
}
